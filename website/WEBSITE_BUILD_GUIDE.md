# Website Build Guide

This guide explains the build process for the Health Checker for Joomla website and the safeguards in place to prevent build issues.

## Quick Start

```bash
cd website
./build.sh
```

## Build Process Overview

The build script performs these steps:

1. **Pre-build Validation** - Ensures HTML template has correct structure
2. **Compile Tailwind CSS** - Minifies CSS (output: `dist/output.css`)
3. **Copy CSS to Public** - Makes CSS available at `/output.css`
4. **Copy Sitemap** - Copies VitePress sitemap to public root (if exists)
5. **Copy LLM Docs** - Copies `llms.txt` and `llms-full.txt` to public root
6. **Minify JavaScript** - Compresses all JS files
7. **Fetch Release Info** - Gets latest version from GitHub (or uses env vars)
8. **Update Metadata** - Updates Schema.org version/dates in both `index.html` and `404.html`
9. **Update Version Display** - Updates visible "Latest version: vX.X.X" text
10. **Post-build Validation** - Verifies output quality

## File Structure

```
website/
├── src/
│   ├── index.js               # Cloudflare Worker (routing, security, 404 handler)
│   └── input.css              # Tailwind source (customizations)
├── dist/
│   └── output.css             # Compiled CSS (temp, not committed)
├── public/
│   ├── index.html             # Main HTML (CSS linked externally)
│   ├── 404.html               # Custom 404 page (generated, version updated)
│   ├── output.css             # Production CSS (generated, committed)
│   ├── sitemap.xml            # SEO sitemap (copied from docs/sitemap.xml)
│   ├── llms.txt               # LLM documentation (copied from docs)
│   ├── llms-full.txt          # Full LLM docs (copied from docs)
│   ├── docs/                  # VitePress built docs
│   │   ├── sitemap.xml        # Generated by VitePress
│   │   ├── llms.txt           # Generated by VitePress
│   │   └── llms-full.txt      # Generated by VitePress
│   ├── waitlist-popover.js    # Minified during build
│   ├── livechat.js            # Minified during build
│   └── search-widget.js       # Generated by VitePress buildEnd hook
├── build.sh                   # Build script with validations
├── wrangler.toml              # Cloudflare Workers config
└── tailwindcss-macos-arm64    # Standalone Tailwind binary
```

## Build Safeguards

### Pre-build Checks

**CSS Link Validation**
- Ensures `index.html` has `<link rel="stylesheet" href="/output.css">`
- Prevents accidental inline CSS in template
- Auto-fixes if inline CSS detected (with backup)

**Size Validation**
- CSS must be 10KB - 200KB (expected: 80KB)
- Fails if CSS suspiciously small or large

### Post-build Checks

**HTML Size Validation**
- HTML must be < 500KB (expected: ~220KB)
- Fails if HTML exceeds limit (suggests CSS inlined)

**Duplication Detection**
- Scans HTML for inline Tailwind CSS
- Fails if any inline CSS found
- Expected: 0 copies in HTML, all CSS external

**File Existence**
- Verifies `public/output.css` exists
- Confirms external CSS properly generated

## Expected Output Sizes

| File | Uncompressed | Brotli | Gzip |
|------|--------------|--------|------|
| index.html | ~220KB | 13.8KB | 19.3KB |
| output.css | 80KB | 13.3KB | 16.2KB |
| waitlist-popover.js | 1.4KB | 0.7KB | 0.9KB |
| livechat.js | 805B | 0.4KB | 0.5KB |
| search-widget.js | 11KB | 4.2KB | 5.0KB |
| **Total** | **315KB** | **30.7KB** | **41.9KB** |

Cloudflare Workers automatically serves compressed versions.

## How CSS is Handled

### Current Approach (External CSS)

✅ **HTML Template** (`public/index.html`)
```html
<link rel="stylesheet" href="/output.css">
```

Benefits:
- CSS cached separately from HTML
- HTML stays small (~220KB)
- Updates to CSS don't invalidate HTML cache
- Better for multi-page sites

### Previous Approach (Inline CSS) - DEPRECATED

❌ **DO NOT USE** - Caused duplication bug
```html
<style>/* CSS here */</style>
```

Issues:
- Build script prepended CSS each run (30 copies!)
- HTML ballooned to 2.6MB
- No caching benefits

## Common Issues

### "ERROR: HTML template missing CSS link!"

**Cause**: `index.html` doesn't have CSS link tag

**Fix**:
```bash
# Ensure this line exists in index.html around line 77:
<link rel="stylesheet" href="/output.css">
```

### "ERROR: HTML file is too large!"

**Cause**: CSS was accidentally inlined

**Fix**: Build script auto-detects and fixes this with backup

### "ERROR: Found inline Tailwind CSS in HTML!"

**Cause**: CSS inlined instead of linked

**Fix**: Build script creates `index.html.broken` backup and auto-fixes

## JavaScript Minification

Build script automatically minifies:
- `waitlist-popover.js` - 52% reduction
- `livechat.js` - 37% reduction
- `search-widget.js` - 46% reduction

Requires `npx` (Node.js) for Terser minifier.

## Version and Metadata Updates

Build script updates these automatically in **both `index.html` and `404.html`**:

### Schema.org Metadata (JSON-LD)
- `softwareVersion` - From GitHub release or `$LATEST_VERSION` env var
- `releaseNotes` - Release URL with version tag
- `downloadUrl` - Direct download link to GitHub release
- `installUrl` - Same as download
- `datePublished` - Release date
- `dateModified` - Release date

### Visible Version Display
- "Latest version: vX.X.X Released DDth MMM YYYY" link
- Format example: "Latest version: v3.0.8 Released 16th Jan 2026"
- Includes proper ordinal suffixes (1st, 2nd, 3rd, 4th, etc.)

### Environment Variables

The build script can use environment variables (set by `release.sh`):
```bash
export LATEST_VERSION="v3.0.8"
export RELEASE_DATE="2026-01-16"
./build.sh
```

If not set, it fetches from GitHub using `gh release list --limit 1`.

## Deployment

### Automated Deployment (via release.sh)

The `build/release.sh` script handles everything automatically:

1. Rebuilds VitePress documentation
2. Builds website with version updates
3. Deploys to Cloudflare Workers

No manual intervention needed!

### Manual Deployment

For manual deployment (development/testing):

1. **Build VitePress docs** (generates docs sitemap, llms.txt):
   ```bash
   cd docs/USER
   npm run docs:build
   ```

2. **Build website** (copies sitemap, minifies assets, updates version):
   ```bash
   cd ../../website
   export LATEST_VERSION="v3.0.8"  # Optional: set version
   export RELEASE_DATE="2026-01-16"  # Optional: set date
   ./build.sh
   ```

3. **Deploy to Cloudflare Workers**:
   ```bash
   npx wrangler deploy
   ```

**Note**: If docs haven't been built, sitemap/llms.txt copy will fail with warnings but build continues.

### Cloudflare Workers Deployment

The website is deployed as a **Cloudflare Worker** (not Pages):

- **Worker script**: `src/index.js` - Handles routing, security headers, 404 pages, waitlist API
- **Assets binding**: `public/` directory served via Workers Assets
- **404 handler**: Serves `404.html` with proper 404 status code
- **Domains**: joomlahealthchecker.com, www.joomlahealthchecker.com, + redirects
- **Config**: `wrangler.toml`

### What Gets Deployed

- Static files from `public/` directory
- Worker script with request handling
- D1 database binding (waitlist)
- Email sending capability
- Custom 404 page support

## Troubleshooting

### Build takes long time

Normal. Tailwind compilation + JS minification takes ~1 second.

### CSS not updating in browser

Clear browser cache or force reload (Cmd+Shift+R).

### Validation fails after manual HTML edit

Run build script - it will auto-fix most issues.

## Historical Context

### CSS Duplication Bug (Fixed Jan 2026)

**Problem**: Build script used `html.replace(/<style>/, '<style>' + css)` which prepended CSS each run instead of replacing.

**Result**: After 30 builds, HTML had 30 copies of CSS (2.6MB!)

**Fix**: Changed to:
1. HTML template has CSS link, not style tag
2. Build script only updates metadata
3. Validation checks prevent duplication

### Migration to External CSS

**Before**: CSS inlined in `<style>` tag (303KB HTML after de-duplication)

**After**: CSS linked externally (224KB HTML + 80KB CSS)

**Benefits**:
- Better caching (CSS cached separately)
- Smaller HTML payload
- Easier to debug
- Prevents duplication bug

## Maintenance

### To Update Tailwind

Edit `src/input.css` and rebuild.

### To Update JavaScript

Edit source JS files, rebuild to minify.

### To Update HTML Structure

Edit `public/index.html` directly. Build script only updates metadata.

## Validation Summary

Every build verifies:

✓ HTML has external CSS link
✓ No inline CSS in HTML
✓ HTML size < 500KB
✓ CSS size 10KB - 200KB
✓ External CSS file exists
✓ Zero CSS duplication

Build fails early if any check fails.
