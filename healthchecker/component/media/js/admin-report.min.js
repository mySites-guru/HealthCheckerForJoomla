/**
 * Health Checker Component - Report Admin JavaScript
 *
 * @copyright   (C) 2026 https://mySites.guru + Phil E. Taylor <phil@phil-taylor.com>
 * @license     GNU General Public License version 2 or later; see LICENSE.txt
 */
!function(e,t){"use strict";e.HealthCheckerReport={init:function(a){const s=a.metadataUrl,n=(a.checkUrl,a.categoryUrl),r="healthchecker_filters",c=a.translations||{};let o={categories:{},providers:{},checks:[],results:{}},l=0,i=0;const d=Date.now();async function g(){const a=t.getElementById("health-check-loading"),r=t.getElementById("health-check-error"),g=t.getElementById("health-check-results"),m=t.getElementById("loading-progress");a.classList.remove("d-none"),r.classList.add("d-none"),g.classList.add("d-none"),t.getElementById("critical-count").textContent="-",t.getElementById("warning-count").textContent="-",t.getElementById("good-count").textContent="-",o={categories:{},providers:{},checks:[],results:{}},l=0,i=0;try{m.textContent=c.loading||"Loading...";const r=await fetch(s+"&_="+d,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}),l=await r.json();if(!l.success)throw new Error(l.message||"Failed to load metadata");o.categories=l.data.categories,o.providers=l.data.providers,o.checks=l.data.checks,i=o.checks.length,function(a){const s=t.getElementById("filter_category");for(;s.options.length>1;)s.remove(1);Object.values(a).sort((e,t)=>e.sortOrder-t.sortOrder).forEach(e=>{const a=t.createElement("option");a.value=e.slug,a.textContent=e.label,s.appendChild(a)}),e._pendingCategoryFilter&&(s.value=e._pendingCategoryFilter,e._pendingCategoryFilter="")}(o.categories),g.classList.remove("d-none"),p(),function(e){const a=Object.values(e).filter(e=>"core"!==e.slug),s=t.getElementById("third-party-providers"),n=t.getElementById("providers-list");if(0===a.length)return void s.classList.add("d-none");s.classList.remove("d-none"),n.innerHTML="",a.forEach(e=>{let t="";e.logoUrl?t=`<img src="${b(e.logoUrl)}" alt="${b(e.name)} logo" class="me-2" style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">`:e.icon&&(t=`<span class="fa ${e.icon} me-2 fs-4" aria-hidden="true"></span>`);let a=b(e.name);e.url&&(a=`<a href="${b(e.url)}" target="_blank" rel="noopener">${a} <span class="icon-out-2 small" aria-hidden="true"></span></a>`),n.innerHTML+=`\n                        <div class="col-md-4 mb-2">\n                            <div class="d-flex align-items-start">\n                                ${t}\n                                <div>\n                                    <strong>${a}</strong>\n                                    ${e.version?`<span class="text-muted">v${b(e.version)}</span>`:""}\n                                    ${e.description?`<div class="small text-muted">${b(e.description)}</div>`:""}\n                                </div>\n                            </div>\n                        </div>\n                    `})}(o.providers);const f=Object.keys(o.categories),y=f.length;m.textContent=`0 / ${y} categories`;const v=f.map((e,t)=>async function(e,t,a,s){try{s.textContent=`Running ${o.categories[e].label||e} (${t}/${a})`;const r=new FormData;r.append("category",e);const c=await fetch(n+"&_="+d,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:r,credentials:"same-origin"}),l=await c.json();l.success&&l.data&&l.data.results&&(Object.entries(l.data.results).forEach(([e,t])=>{o.results[e]=t,u(e,t)}),h())}catch(t){console.error(`Failed to run category ${e}:`,t)}}(e,t+1,y,m));await Promise.all(v),a.classList.add("d-none"),p(),h(),t.getElementById("last-checked").textContent=(c.lastChecked||"Last checked: %s").replace("%s",(new Date).toLocaleString())}catch(e){a.classList.add("d-none"),r.classList.remove("d-none"),t.getElementById("health-check-error-message").textContent=e.message||"Network error"}}function u(e,a){const s=t.getElementById(`check-row-${e.replace(/\./g,"-")}`);if(!s)return;const n=y(a.status),r=o.providers[a.provider];let l="";"core"!==a.provider&&r&&(l=`<span class="badge bg-secondary hasTooltip" title="${b(r.name+(r.version?" v"+r.version:""))}">${b(r.name)}</span>`);let i="";a.actionUrl&&(i+=`<a href="${b(a.actionUrl)}" class="btn btn-sm btn-outline-primary">${c.explore||"Explore"}</a>`),a.docsUrl&&(i+=`<a href="${b(a.docsUrl)}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary ms-1 healthchecker-no-external-icon">${c.docs||"Docs"}</a>`),s.innerHTML=`\n                    <td>\n                        <span class="badge ${n.badgeClass}">\n                            <span class="fa ${n.icon}" aria-hidden="true"></span>\n                            ${n.label}\n                        </span>\n                    </td>\n                    <td>${b(a.title)}</td>\n                    <td>${l}</td>\n                    <td class="healthchecker-description">${a.description}</td>\n                    <td class="text-end text-nowrap">${i}</td>\n                `,function(e){const a=t.getElementById(`category-card-${e}`);if(!a)return;const s=Object.values(o.results).filter(t=>t.category===e),n=s.some(e=>"critical"===e.status),r=s.some(e=>"warning"===e.status);a.classList.remove("border-danger","border-warning","border-success"),n?a.classList.add("border-danger"):r?a.classList.add("border-warning"):s.length>0&&a.classList.add("border-success");!function(e){const a=t.getElementById(`category-badges-${e}`);if(!a)return;const s=Object.values(o.results).filter(t=>t.category===e),n=s.filter(e=>"critical"===e.status).length,r=s.filter(e=>"warning"===e.status).length,l=s.filter(e=>"good"===e.status).length;let i="";n>0&&(i+=`<span class="badge bg-danger">${n} ${c.critical||"Critical"}</span> `);r>0&&(i+=`<span class="badge bg-warning text-dark">${r} ${c.warning||"Warning"}</span> `);l>0&&(i+=`<span class="badge bg-success">${l} ${c.good||"Good"}</span>`);a.innerHTML=i}(e)}(a.category)}function h(){const e=Object.values(o.results),a=e.filter(e=>"critical"===e.status).length,s=e.filter(e=>"warning"===e.status).length,n=e.filter(e=>"good"===e.status).length;t.getElementById("critical-count").textContent=a,t.getElementById("warning-count").textContent=s,t.getElementById("good-count").textContent=n}function p(){const e=t.getElementById("healthCheckCategories");e.innerHTML="";const a=t.getElementById("filter_search").value.toLowerCase().trim(),s=t.getElementById("filter_status").value,n=t.getElementById("filter_category").value,r=Object.values(o.categories).sort((e,t)=>e.sortOrder-t.sortOrder);r.forEach(t=>{if(n&&t.slug!==n)return;let r=o.checks.filter(e=>e.category===t.slug);if(0===r.length)return;const l=Object.values(o.results).filter(e=>e.category===t.slug);let i=l;if(s&&(i="hide_good"===s?l.filter(e=>"good"!==e.status):l.filter(e=>e.status===s),0===i.length&&l.length>0))return;if(a&&(i=i.filter(e=>e.title.toLowerCase().includes(a)||e.description.toLowerCase().includes(a)||e.slug.toLowerCase().includes(a)),0===i.length))return;const d=l.filter(e=>"critical"===e.status).length,g=l.filter(e=>"warning"===e.status).length,u=l.filter(e=>"good"===e.status).length;let h="";d>0?h="border-danger":g>0?h="border-warning":u>0&&(h="border-success");let p="";d>0&&(p+=`<span class="badge bg-danger">${d} ${c.critical||"Critical"}</span> `),g>0&&(p+=`<span class="badge bg-warning text-dark">${g} ${c.warning||"Warning"}</span> `),u>0&&(p+=`<span class="badge bg-success">${u} ${c.good||"Good"}</span>`);let m=r;if(s||a){i.map(e=>e.slug);m=r.filter(e=>{const t=o.results[e.slug];if(!t)return!1;let n=!0;s&&(n="hide_good"===s?"good"!==t.status:t.status===s);let r=!a||t.title.toLowerCase().includes(a)||t.description.toLowerCase().includes(a)||t.slug.toLowerCase().includes(a);return n&&r})}let f="";m.forEach(e=>{const t=o.results[e.slug],a=`check-row-${e.slug.replace(/\./g,"-")}`;if(t){const e=y(t.status),s=o.providers[t.provider];let n="";"core"!==t.provider&&s&&(n=`<span class="badge bg-secondary hasTooltip" title="${b(s.name+(s.version?" v"+s.version:""))}">${b(s.name)}</span>`);let r="";t.actionUrl&&(r+=`<a href="${b(t.actionUrl)}" class="btn btn-sm btn-outline-primary">${c.explore||"Explore"}</a>`),t.docsUrl&&(r+=`<a href="${b(t.docsUrl)}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary ms-1 healthchecker-no-external-icon">${c.docs||"Docs"}</a>`),f+=`\n                                <tr id="${a}">\n                                    <td>\n                                        <span class="badge ${e.badgeClass}">\n                                            <span class="fa ${e.icon}" aria-hidden="true"></span>\n                                            ${e.label}\n                                        </span>\n                                    </td>\n                                    <td>${b(t.title)}</td>\n                                    <td>${n}</td>\n                                    <td class="healthchecker-description">${t.description}</td>\n                                    <td class="text-end text-nowrap">${r}</td>\n                                </tr>\n                            `}else f+=`\n                                <tr id="${a}">\n                                    <td>\n                                        <span class="badge bg-secondary d-inline-flex align-items-center gap-1">\n                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>\n                                            ${c.checking||"Checking..."}\n                                        </span>\n                                    </td>\n                                    <td>${b(e.title)}</td>\n                                    <td></td>\n                                    <td class="text-muted">${c.runningChecks||"Running checks..."}</td>\n                                    <td></td>\n                                </tr>\n                            `});const v=t.label;let $="";t.logoUrl?$=`<img src="${b(t.logoUrl)}" alt="${b(v)} icon" class="me-2" style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px;">`:t.icon&&($=`<span class="fa ${t.icon} me-2" aria-hidden="true"></span>`);const w="true"===localStorage.getItem(`healthchecker-category-${t.slug}-collapsed`),E=w?"":"show",L=w?"fa-chevron-right":"fa-chevron-down";e.innerHTML+=`\n                        <div class="card mb-3 ${h}" id="category-card-${t.slug}">\n                            <div class="card-header d-flex justify-content-between align-items-center"\n                                 style="cursor: pointer;"\n                                 role="button"\n                                 data-bs-toggle="collapse"\n                                 data-bs-target="#category-collapse-${t.slug}"\n                                 aria-expanded="${!w}"\n                                 aria-controls="category-collapse-${t.slug}">\n                                <h5 class="mb-0 d-flex align-items-center">\n                                    <span class="fa ${L} me-2" aria-hidden="true" id="category-chevron-${t.slug}"></span>\n                                    ${$}\n                                    ${b(v)}\n                                </h5>\n                                <span id="category-badges-${t.slug}">${p}</span>\n                            </div>\n                            <div class="collapse ${E}" id="category-collapse-${t.slug}">\n                                <div class="card-body p-0">\n                                    <table class="table table-striped mb-0">\n                                        <colgroup>\n                                            <col style="width: 100px;">\n                                            <col style="width: 300px;">\n                                            <col style="width: 150px;">\n                                            <col>\n                                            <col style="width: 140px;">\n                                        </colgroup>\n                                        <tbody>${f}</tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        </div>\n                    `}),new bootstrap.Tooltip(t.body,{selector:".hasTooltip"}),r.forEach(e=>{const a=t.getElementById(`category-collapse-${e.slug}`),s=t.getElementById(`category-chevron-${e.slug}`);a&&s&&(a.addEventListener("shown.bs.collapse",function(){localStorage.setItem(`healthchecker-category-${e.slug}-collapsed`,"false"),s.classList.remove("fa-chevron-right"),s.classList.add("fa-chevron-down")}),a.addEventListener("hidden.bs.collapse",function(){localStorage.setItem(`healthchecker-category-${e.slug}-collapsed`,"true"),s.classList.remove("fa-chevron-down"),s.classList.add("fa-chevron-right")}))})}function m(){!function(){const a={search:t.getElementById("filter_search").value,status:t.getElementById("filter_status").value,category:t.getElementById("filter_category").value};localStorage.setItem(r,JSON.stringify(a));const s=new URL(e.location);a.search?s.searchParams.set("search",a.search):s.searchParams.delete("search"),a.status?s.searchParams.set("status",a.status):s.searchParams.delete("status"),a.category?s.searchParams.set("category",a.category):s.searchParams.delete("category"),e.history.replaceState({},"",s)}(),f(),p()}function f(){const e=t.getElementById("filter_status").value;t.querySelectorAll(".status-filter-card").forEach(t=>{const a=t.dataset.status;t.classList.remove("active","dimmed"),e&&(e===a?t.classList.add("active"):"hide_good"===e&&"good"!==a||t.classList.add("dimmed"),"hide_good"===e&&"good"===a&&t.classList.add("dimmed"))})}function y(e){const t={critical:{label:c.critical||"Critical",icon:"fa-times-circle",badgeClass:"bg-danger"},warning:{label:c.warning||"Warning",icon:"fa-exclamation-triangle",badgeClass:"bg-warning text-dark"},good:{label:c.good||"Good",icon:"fa-check-circle",badgeClass:"bg-success"}};return t[e]||t.good}function b(e){const a=t.createElement("div");return a.textContent=e,a.innerHTML}!function(){const a=new URL(e.location),s=a.searchParams.get("search"),n=a.searchParams.get("status"),c=a.searchParams.get("category");let o={search:"",status:"",category:""};const l=localStorage.getItem(r);if(l)try{o=JSON.parse(l)}catch(e){}null!==s&&(o.search=s),null!==n&&(o.status=n),null!==c&&(o.category=c),t.getElementById("filter_search").value=o.search||"",t.getElementById("filter_status").value=o.status||"",e._pendingCategoryFilter=o.category||""}(),f(),g(),t.getElementById("filter_search").addEventListener("input",m),t.getElementById("filter_status").addEventListener("change",m),t.getElementById("filter_category").addEventListener("change",m),t.querySelectorAll(".status-filter-card").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.status,a=t.getElementById("filter_status");a.value===e?a.value="":a.value=e,m()})});const v=t.getElementById("retry-health-check");v&&v.addEventListener("click",function(){g()}),e.runHealthChecks=g}},t.addEventListener("DOMContentLoaded",function(){const a=t.getElementById("adminForm");if(!a)return;const s=a.dataset.metadataUrl,n=a.dataset.checkUrl,r=a.dataset.categoryUrl;s&&n&&r&&e.HealthCheckerReport.init({metadataUrl:s,checkUrl:n,categoryUrl:r,translations:{loading:a.dataset.textLoading||"Loading...",lastChecked:a.dataset.textLastChecked||"Last checked: %s",runningChecks:a.dataset.textRunningChecks||"Running checks...",critical:a.dataset.textCritical||"Critical",warning:a.dataset.textWarning||"Warning",good:a.dataset.textGood||"Good",checking:a.dataset.textChecking||"Checking...",viewDocs:a.dataset.textViewDocs||"View Documentation"}})})}(window,document);
//# sourceMappingURL=admin-report.min.js.map